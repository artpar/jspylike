<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSPyLike Playground - Python 3 in JavaScript</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
        }

        header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1a1a1a;
            letter-spacing: -0.025em;
        }

        .header-meta {
            display: flex;
            gap: 12px;
            align-items: center;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .meta-item::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #10b981;
        }

        .header-links {
            display: flex;
            gap: 16px;
        }

        .header-links a {
            color: #6b7280;
            text-decoration: none;
            font-size: 0.875rem;
            transition: color 0.2s;
        }

        .header-links a:hover {
            color: #2563eb;
        }

        .playground {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            flex: 1;
            overflow: hidden;
        }

        .editor-section, .output-section {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-section {
            border-right: 1px solid #e5e7eb;
        }

        .section-header {
            background: #fafafa;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        button {
            padding: 6px 14px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.15s;
            background: white;
            color: #374151;
        }

        .run-btn {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .run-btn:hover {
            background: #1d4ed8;
            border-color: #1d4ed8;
        }

        .run-btn:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            border-color: #e5e7eb;
            cursor: not-allowed;
        }

        .clear-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        select {
            padding: 6px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            background: white;
            color: #374151;
        }

        select:hover {
            border-color: #d1d5db;
        }

        .CodeMirror {
            height: 100% !important;
            font-size: 13px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        }

        .output-content {
            flex: 1;
            padding: 16px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            overflow-y: auto;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .output-line {
            margin-bottom: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .output-error {
            color: #f87171;
            background: rgba(248, 113, 113, 0.1);
            padding: 8px 12px;
            border-left: 3px solid #ef4444;
            border-radius: 4px;
            margin: 4px 0;
        }

        .output-success {
            color: #34d399;
        }

        .output-info {
            color: #60a5fa;
        }

        .tabs {
            display: flex;
            gap: 0;
        }

        .tab-btn {
            padding: 8px 16px;
            border: none;
            border-bottom: 2px solid transparent;
            background: transparent;
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border-radius: 0;
        }

        .tab-btn:hover {
            color: #374151;
            background: transparent;
        }

        .tab-btn.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .ast-content {
            flex: 1;
            padding: 16px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            overflow-y: auto;
            background: #1e1e1e;
            color: #d4d4d4;
            white-space: pre;
        }

        .ast-node {
            margin-left: 16px;
        }

        .ast-key {
            color: #9cdcfe;
        }

        .ast-string {
            color: #ce9178;
        }

        .ast-number {
            color: #b5cea8;
        }

        .ast-boolean {
            color: #569cd6;
        }

        .ast-null {
            color: #569cd6;
        }

        .ast-type {
            color: #4ec9b0;
            font-weight: bold;
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.6s linear infinite;
            margin-left: 6px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 968px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .header-links {
                width: 100%;
                justify-content: flex-start;
            }

            .playground {
                grid-template-columns: 1fr;
            }

            .editor-section {
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
                min-height: 400px;
            }

            .output-section {
                min-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1>JSPyLike Playground</h1>
                <div class="header-meta">
                    <span class="meta-item">1333 tests passing</span>
                    <span class="meta-item">v1.0.0</span>
                </div>
            </div>
            <div class="header-links">
                <a href="https://github.com/artpar/jspylike" target="_blank">GitHub</a>
                <a href="https://www.npmjs.com/package/jspylike" target="_blank">NPM</a>
                <a href="https://github.com/artpar/jspylike#readme" target="_blank">Docs</a>
            </div>
        </header>

        <div class="playground">
            <div class="editor-section">
                <div class="section-header">
                    <h2>Editor</h2>
                    <div class="controls">
                        <select id="examples">
                            <option value="">Examples</option>
                            <option value="hello">Hello World</option>
                            <option value="fibonacci">Fibonacci</option>
                            <option value="classes">Classes</option>
                            <option value="async">Async/Await</option>
                            <option value="comprehensions">Comprehensions</option>
                            <option value="decorators">Decorators</option>
                            <option value="generators">Generators</option>
                        </select>
                    </div>
                </div>
                <textarea id="code"># Welcome to JSPyLike Playground
# Write Python 3 code and press Ctrl/Cmd+Enter to run

def greet(name):
    return f"Hello, {name}!"

print(greet("World"))

# Try Python features
numbers = [1, 2, 3, 4, 5]
squares = [x**2 for x in numbers]
print(f"Squares: {squares}")
</textarea>
            </div>

            <div class="output-section">
                <div class="section-header">
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="console">Console</button>
                        <button class="tab-btn" data-tab="ast">AST</button>
                    </div>
                    <div class="controls">
                        <button class="run-btn" id="runBtn">Run</button>
                        <button class="clear-btn" id="clearBtn">Clear</button>
                    </div>
                </div>
                <div class="tab-content active" id="console-tab">
                    <div class="output-content" id="output">
                        <div class="output-info">Loading interpreter...</div>
                    </div>
                </div>
                <div class="tab-content" id="ast-tab">
                    <div class="ast-content" id="ast-output">
                        <span class="output-info">Parse the code to see the AST</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script type="module">
        // Always load from GitHub CDN with cache-busting timestamp
        // jsDelivr purges cache on new commits, @latest always gets newest version
        const cdnBase = 'https://cdn.jsdelivr.net/gh/artpar/jspylike@main/src';

        // Dynamic import with cache-busting query param
        const cacheBuster = Date.now();
        const { Interpreter, PyBuiltin, PY_NONE, Parser, Lexer } = await import(`${cdnBase}/index.js?v=${cacheBuster}`);

        const examples = {
            hello: `# Hello World
print("Hello, World!")

# Variables and types
name = "Python"
version = 3
active = True

print(f"{name} {version} is active: {active}")`,

            fibonacci: `# Fibonacci sequence
def fibonacci(n):
    a, b = 0, 1
    result = []
    for _ in range(n):
        result.append(a)
        a, b = b, a + b
    return result

print("First 10 Fibonacci numbers:")
print(fibonacci(10))`,

            classes: `# Object-Oriented Programming
class Animal:
    def __init__(self, name):
        self.name = name

    def speak(self):
        return "Some sound"

class Dog(Animal):
    def speak(self):
        return f"{self.name} says Woof!"

class Cat(Animal):
    def speak(self):
        return f"{self.name} says Meow!"

dog = Dog("Buddy")
cat = Cat("Whiskers")

print(dog.speak())
print(cat.speak())`,

            async: `# Async/Await
async def fetch_data(item):
    return f"Fetched: {item}"

async def process_items():
    items = ["apple", "banana", "cherry"]
    results = []

    for item in items:
        data = await fetch_data(item)
        results.append(data)

    return results

result = await process_items()
print("Results:", result)`,

            comprehensions: `# List Comprehensions
numbers = range(1, 11)

# Basic list comprehension
squares = [x**2 for x in numbers]
print("Squares:", squares)

# With condition
evens = [x for x in numbers if x % 2 == 0]
print("Evens:", evens)

# Dict comprehension
square_dict = {x: x**2 for x in range(1, 6)}
print("Square dict:", square_dict)

# Set comprehension
unique_lengths = {len(word) for word in ["hello", "world", "python", "code"]}
print("Unique word lengths:", unique_lengths)`,

            decorators: `# Decorators
def uppercase(func):
    def wrapper(*args, **kwargs):
        result = func(*args, **kwargs)
        return result.upper()
    return wrapper

def repeat(times):
    def decorator(func):
        def wrapper(*args, **kwargs):
            results = []
            for _ in range(times):
                results.append(func(*args, **kwargs))
            return results
        return wrapper
    return decorator

@uppercase
def greet(name):
    return f"hello, {name}"

@repeat(3)
def say(word):
    return word

print(greet("world"))
print(say("Python!"))`,

            generators: `# Generators
def countdown(n):
    while n > 0:
        yield n
        n -= 1

print("Countdown:")
for num in countdown(5):
    print(num)

# Generator expression
squares_gen = (x**2 for x in range(5))
print("\\nSquares from generator:")
for square in squares_gen:
    print(square)`
        };

        // Initialize CodeMirror
        const editor = CodeMirror.fromTextArea(document.getElementById('code'), {
            mode: 'python',
            theme: 'monokai',
            lineNumbers: true,
            indentUnit: 4,
            indentWithTabs: false,
            lineWrapping: true
        });

        const output = document.getElementById('output');
        const astOutput = document.getElementById('ast-output');
        const runBtn = document.getElementById('runBtn');
        const clearBtn = document.getElementById('clearBtn');
        const examplesSelect = document.getElementById('examples');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        // Tab switching
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });

        // Custom print function to capture output
        let outputLines = [];

        // BigInt-safe JSON stringifier
        function safeStringify(obj) {
            return JSON.stringify(obj, (key, value) =>
                typeof value === 'bigint' ? Number(value) : value
            );
        }

        // Pretty print AST with syntax highlighting
        function renderAST(node, indent = 0) {
            const pad = '  '.repeat(indent);

            if (node === null) {
                return `<span class="ast-null">null</span>`;
            }

            if (typeof node === 'string') {
                return `<span class="ast-string">"${escapeHtml(node)}"</span>`;
            }

            if (typeof node === 'number' || typeof node === 'bigint') {
                return `<span class="ast-number">${node}</span>`;
            }

            if (typeof node === 'boolean') {
                return `<span class="ast-boolean">${node}</span>`;
            }

            if (Array.isArray(node)) {
                if (node.length === 0) return '[]';
                const items = node.map(item => `${pad}  ${renderAST(item, indent + 1)}`).join(',\n');
                return `[\n${items}\n${pad}]`;
            }

            if (typeof node === 'object') {
                const keys = Object.keys(node);
                if (keys.length === 0) return '{}';

                const typeStr = node.type ? `<span class="ast-type">${escapeHtml(node.type)}</span>` : null;
                const entries = keys
                    .filter(k => k !== 'type')
                    .map(key => {
                        const val = renderAST(node[key], indent + 1);
                        return `${pad}  <span class="ast-key">${escapeHtml(key)}</span>: ${val}`;
                    });

                if (typeStr) {
                    entries.unshift(`${pad}  <span class="ast-key">type</span>: ${typeStr}`);
                }

                return `{\n${entries.join(',\n')}\n${pad}}`;
            }

            return String(node);
        }

        function updateAST(code) {
            try {
                const lexer = new Lexer(code);
                const tokens = lexer.tokenize();
                const parser = new Parser(tokens);
                const ast = parser.parse();
                astOutput.innerHTML = renderAST(ast);
            } catch (error) {
                astOutput.innerHTML = `<span class="output-error">${escapeHtml(error.message)}</span>`;
            }
        }

        function customPrint(...args) {
            const line = args.map(arg => {
                if (typeof arg === 'object' && arg !== null) {
                    if (arg.toJS) return safeStringify(arg.toJS());
                    if (arg.value !== undefined) return String(arg.value);
                    return safeStringify(arg);
                }
                return String(arg);
            }).join(' ');
            outputLines.push({ type: 'output', text: line });
            updateOutput();
        }

        function addOutput(text, type = 'info') {
            outputLines.push({ type, text });
            updateOutput();
        }

        function updateOutput() {
            output.innerHTML = outputLines.map(line => {
                const className = line.type === 'error' ? 'output-error' :
                                 line.type === 'success' ? 'output-success' :
                                 'output-line';
                return `<div class="${className}">${escapeHtml(line.text)}</div>`;
            }).join('');
            output.scrollTop = output.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function runCode() {
            const code = editor.getValue();
            outputLines = [];
            runBtn.disabled = true;
            runBtn.innerHTML = 'Running<span class="loading"></span>';

            // Update AST view
            updateAST(code);

            try {
                const interpreter = new Interpreter();

                // Override print function to capture output
                interpreter.globalScope.set('print', new PyBuiltin('print', (...args) => {
                    const line = args.map(arg => {
                        // Handle Python objects with __str__ method
                        if (arg && arg.__str__) return arg.__str__();
                        // Handle Python objects with value property
                        if (typeof arg === 'object' && arg !== null) {
                            if (arg.toJS) return safeStringify(arg.toJS());
                            if (arg.value !== undefined) return String(arg.value);
                            return safeStringify(arg);
                        }
                        return String(arg);
                    }).join(' ');
                    outputLines.push({ type: 'output', text: line });
                    updateOutput();
                    return PY_NONE;
                }, 0, Infinity));

                // Check if code contains async/await
                const isAsync = /\bawait\b/.test(code) || /^async\s+def\b/m.test(code);

                if (isAsync) {
                    const result = await interpreter.runAsync(code);
                    if (result && result.value !== undefined && result.value !== null) {
                        if (outputLines.length === 0) {
                            addOutput(`${result.value}`, 'success');
                        }
                    }
                } else {
                    const result = interpreter.run(code);
                    if (result && result.value !== undefined && result.value !== null) {
                        if (outputLines.length === 0) {
                            addOutput(`${result.value}`, 'success');
                        }
                    }
                }

                if (outputLines.length === 0) {
                    addOutput('(no output)', 'info');
                }

            } catch (error) {
                console.error('Error:', error);
                const errorMsg = error.pyMessage || error.message || String(error);
                const errorType = error.pyType || error.name || 'Error';
                addOutput(`${errorType}: ${errorMsg}`, 'error');

                if (error.stack) {
                    console.log('Stack trace:', error.stack);
                }
            } finally {
                runBtn.disabled = false;
                runBtn.innerHTML = 'Run';
            }
        }

        function clearOutput() {
            outputLines = [];
            output.innerHTML = '<div class="output-info">Ready. Press Run or Ctrl/Cmd+Enter to execute.</div>';
            astOutput.innerHTML = '<span class="output-info">Run the code to see the AST</span>';
        }

        // Event listeners
        runBtn.addEventListener('click', runCode);
        clearBtn.addEventListener('click', clearOutput);

        examplesSelect.addEventListener('change', (e) => {
            const example = e.target.value;
            if (example && examples[example]) {
                editor.setValue(examples[example]);
                clearOutput();
                updateAST(examples[example]);
            }
            e.target.value = '';
        });

        // Keyboard shortcut: Ctrl+Enter or Cmd+Enter to run
        editor.setOption('extraKeys', {
            'Ctrl-Enter': runCode,
            'Cmd-Enter': runCode
        });

        // Mark as ready and parse initial code
        output.innerHTML = '<div class="output-info">Ready. Press Run or Ctrl/Cmd+Enter to execute.</div>';
        updateAST(editor.getValue());
    </script>
</body>
</html>
